<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vosk Fixed Render</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/coi-serviceworker/0.1.7/coi-serviceworker.min.js"></script>
    <style>
        body { background: #121212; color: #fff; font-family: sans-serif; text-align: center; padding: 20px; }
        .console { background: #000; color: #0f0; padding: 10px; border-radius: 8px; text-align: left; font-family: monospace; height: 150px; overflow-y: auto; margin-bottom: 20px; border: 1px solid #333; }
        button { background: #1a73e8; color: white; border: none; padding: 15px 30px; border-radius: 10px; font-size: 18px; cursor: pointer; width: 100%; }
        button:disabled { background: #444; }
        #res { font-size: 24px; margin: 20px 0; color: #00ff00; }
    </style>
</head>
<body>

    <div class="console" id="log">Ожидание запуска...</div>
    <button id="startBtn" onclick="initVosk()">ЗАПУСТИТЬ НЕЙРОСЕТЬ</button>
    <div id="res">Текст появится здесь</div>

    <script>
        let model, recognizer, active = false;

        function addLog(m) {
            const l = document.getElementById('log');
            l.innerHTML += `> ${m}<br>`;
            l.scrollTop = l.scrollHeight;
        }

        async function initVosk() {
            const btn = document.getElementById('startBtn');
            try {
                btn.disabled = true;
                addLog("Проверка окружения...");
                
                // Проверяем, загружен ли скрипт Vosklet (если CDN все-таки сработал)
                if (typeof loadVosklet === 'undefined') {
                    addLog("ОШИБКА: Библиотека loadVosklet не загружена из CDN.");
                    addLog("Пробую динамическую загрузку...");
                    await import('https://cdn.jsdelivr.net/gh/msqr1/Vosklet@1.2.1/Examples/Vosklet.js');
                }

                addLog("Запрос микрофона...");
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const ctx = new AudioContext({ sampleRate: 16000 });

                addLog("Инициализация Vosklet...");
                const module = await loadVosklet(); 
                
                addLog("Загрузка модели (45MB)...");
                // Используем стабильную ссылку
                const url = "https://msqr1.github.io/Vosklet/models/vosk-model-small-ru-0.22.tar.gz";
                
                model = await module.createModel(url, "Russian", "vosk-model-small-ru-0.22");
                
                if (!model) throw new Error("Модель вернула undefined");

                addLog("Создание распознавателя...");
                recognizer = await module.createRecognizer(model, ctx.sampleRate);

                const transferer = await module.createTransferer(ctx, 128 * 150);
                transferer.port.onmessage = (e) => {
                    if (recognizer) recognizer.acceptWaveform(e.data);
                };

                const source = ctx.createMediaStreamSource(stream);
                source.connect(transferer);

                recognizer.addEventListener("result", (e) => {
                    if (e.detail.text) document.getElementById('res').innerText = e.detail.text;
                });

                addLog("ГОТОВО! ГОВОРИТЕ.");
                btn.innerText = "РАБОТАЕТ";

            } catch (e) {
                addLog("КРИТИЧЕСКАЯ ОШИБКА: " + e.message);
                btn.disabled = false;
                btn.innerText = "ОШИБКА (ПОВТОР)";
            }
        }
    </script>
</body>
</html>
