<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Vosklet Russian Demo</title>
    <script src="https://cdn.jsdelivr.net/gh/msqr1/Vosklet@1.2.1/Examples/Vosklet.js" async defer></script>
    <style>
        body { font-family: sans-serif; padding: 20px; text-align: center; }
        #status { color: #666; margin-bottom: 10px; }
        #result { font-weight: bold; margin-top: 20px; font-size: 1.2em; color: #2c3e50; }
        #partial { color: #7f8c8d; font-style: italic; }
        button { padding: 10px 20px; cursor: pointer; font-size: 16px; }
    </style>
    
    <script>
      async function start() {
        const status = document.getElementById("status");
        const resultDiv = document.getElementById("result");
        const partialDiv = document.getElementById("partial");
        const startBtn = document.getElementById("startBtn");

        try {
            startBtn.disabled = true;
            status.innerText = "Загрузка модели (около 45 МБ), подождите...";

            // Создаем аудио-контекст
            let ctx = new AudioContext({sinkId: {type: "none"}});

            // Настройка микрофона
            let stream = await navigator.mediaDevices.getUserMedia({
                video: false,
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    channelCount: 1
                },
            });
            let micNode = ctx.createMediaStreamSource(stream);

            // Загрузка Vosklet
            let module = await loadVosklet();
            
            // Заменяем на РУССКУЮ маленькую модель
            let model = await module.createModel(
                "https://ccoreilly.github.io/vosk-browser/models/vosk-model-small-ru-0.22.tar.gz",
                "Russian",
                "vosk-model-small-ru-0.22"
            );
            
            let recognizer = await module.createRecognizer(model, ctx.sampleRate);

            status.innerText = "Слушаю...";

            // Обработка финального результата
            recognizer.addEventListener("result", ev => {
                const text = ev.detail.text;
                if(text) {
                    resultDiv.innerText = "Распознано: " + text;
                    partialDiv.innerText = ""; // Очищаем промежуточный
                }
            });

            // Обработка промежуточных результатов
            recognizer.addEventListener("partialResult", ev => {
                const partialText = ev.detail.partial;
                if(partialText) {
                    partialDiv.innerText = partialText;
                }
            });

            // Узел передачи данных
            let transferer = await module.createTransferer(ctx, 128 * 150);
            transferer.port.onmessage = ev => recognizer.acceptWaveform(ev.data);

            micNode.connect(transferer);

        } catch (err) {
            console.error(err);
            status.innerText = "Ошибка: " + err.message;
            startBtn.disabled = false;
        }
      }
    </script>
</head>
<body>
    <h1>Распознавание речи (Vosk Offline)</h1>
    <div id="status">Нажмите кнопку для запуска</div>
    <button id="startBtn" onclick="start()">Запустить микрофон</button>
    
    <div id="result"></div>
    <div id="partial"></div>

    <hr style="margin-top: 40px;">
    <p><small>Примечание: При первом запуске скачивается модель (~45МБ). Результаты выводятся в консоль браузера (F12) и на экран.</small></p>
</body>
</html>
