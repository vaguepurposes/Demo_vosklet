<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Vosk Copy-Paste Test</title>
    <script src="https://cdn.jsdelivr.net/gh/msqr1/Vosklet@1.2.1/Examples/Vosklet.js"></script>
    <style>
        body { background: #000; color: #0f0; font-family: monospace; padding: 20px; text-align: center; }
        #status { border: 1px solid #0f0; padding: 10px; margin-bottom: 20px; min-height: 60px; text-align: left; font-size: 12px; }
        #text { font-size: 20px; color: #fff; margin: 20px; }
        button { background: #0f0; color: #000; border: none; padding: 15px 30px; font-weight: bold; cursor: pointer; width: 100%; }
    </style>
</head>
<body>
    <div id="status">Лог готов...</div>
    <button id="go" onclick="start()">ЗАПУСТИТЬ КАК ТАМ</button>
    <div id="text"></div>
    <div id="partial" style="color: #666"></div>

<script>
    let model, recognizer, module;

    async function log(m) {
        document.getElementById('status').innerHTML += m + '<br>';
        console.log(m);
    }

    async function start() {
        try {
            document.getElementById('go').disabled = true;
            log("1. Проверка SharedArrayBuffer: " + (typeof SharedArrayBuffer !== 'undefined'));
            
            log("2. Запрос микрофона...");
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const ctx = new AudioContext({ sampleRate: 16000 });
            const source = ctx.createMediaStreamSource(stream);

            log("3. Загрузка Vosklet...");
            module = await loadVosklet();

            log("4. Загрузка модели (этот этап самый опасный)...");
            // Пробуем ссылку, которую они используют внутри своего приложения
            const url = "https://msqr1.github.io/Vosklet/models/vosk-model-small-ru-0.22.tar.gz";
            
            model = await module.createModel(url, "Russian", "vosk-model-small-ru-0.22");

            if (!model) {
                log("ОШИБКА: Модель не создалась (undefined)");
                return;
            }

            log("5. Модель готова. Создаем рекогнайзер...");
            recognizer = await module.createRecognizer(model, ctx.sampleRate);

            log("6. Запуск передачи данных...");
            const transferer = await module.createTransferer(ctx, 128 * 150);
            transferer.port.onmessage = (e) => recognizer.acceptWaveform(e.data);
            source.connect(transferer);

            recognizer.addEventListener("result", (e) => {
                if (e.detail.text) document.getElementById('text').innerText = e.detail.text;
            });

            recognizer.addEventListener("partialResult", (e) => {
                if (e.detail.partial) document.getElementById('partial').innerText = e.detail.partial;
            });

            log("7. ВСЁ РАБОТАЕТ. ГОВОРИ!");
            document.getElementById('go').innerText = "РАБОТАЕТ";

        } catch (e) {
            log("КРИТИЧЕСКИЙ ВЫЛЕТ: " + e.message);
            document.getElementById('go').disabled = false;
        }
    }
</script>
</body>
</html>
